<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POPCORN</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 20px;

  /* Warna dasar */
  background-color: #f5f7ec;

  /* Grid background */
  background-image:
    linear-gradient(#e1e6da 1px, transparent 1px),
    linear-gradient(90deg, #e1e6da 1px, transparent 1px);
  background-size: 30px 30px; /* ukuran kotak grid */
}
    <style>
body {
  font-family: Arial, sans-serif;
  background:#f5f7fa;
  margin:0;
  padding:20px;
}
.wrapper {
  max-width:1200px;
  margin:auto;
}
.header {
  display:flex;
  gap:15px;
  align-items:center;
  margin-bottom:20px;
}
select {
  padding:8px 12px;
  font-size:14px;
}
.chart-box {
  background:#fff;
  border-radius:10px;
  padding:20px;
  box-shadow:0 4px 12px rgba(0,0,0,.1);
}
canvas {
  width:100% !important;
  max-height:450px;
}
.status {
  margin-bottom:15px;
}
.table-box {
  background: #fff;
  border-radius: 10px;
  padding: 20px;
  box-shadow: 0 4px 12px rgba(0,0,0,.1);
  margin-top: 20px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
}
th {
  background-color: #f2f2f2;
}
td.panen {
  background-color: #4CAF50; /* Hijau */
  color: white;
}
.modal {
  display: none;
  position: fixed;
  z-index: 1;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgb(0,0,0);
  background-color: rgba(0,0,0,0.4);
}
.modal-content {
  background-color: #fefefe;
  margin: 15% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  max-width: 400px;
}
.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}
.close:hover,
.close:focus {
  color: black;
  text-decoration: none;
  cursor: pointer;
}

td.panen {
  background-color: #4CAF50; /* Hijau */
  color: white;
  cursor: pointer; /* Tambahkan ini agar terlihat clickable */
}

@media (max-width: 1024px) {
  /* Wrapper utama: Kurangi padding dan margin untuk layar kecil */
  .wrapper {
    padding: 10px;
    margin: 0 auto;
  }
  
  /* Header: Susun elemen secara vertikal di tablet/HP */
  .header {
    flex-direction: column;
    gap: 10px;
    align-items: stretch;
  }
  
  /* Tombol tahun dan bulan: Bungkus tombol agar tidak overflow, gunakan flex-wrap */
  #tahun-buttons, #bulan-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
  }
  #tahun-buttons .btn, #bulan-buttons .btn {
    flex: 1 1 auto; /* Tombol akan menyesuaikan lebar */
    min-width: 80px; /* Minimal lebar agar tidak terlalu kecil */
    font-size: 12px; /* Font lebih kecil untuk HP */
    padding: 6px 10px;
  }
  
  /* Cards dashboard: Susun dalam 2 kolom di tablet, 1 kolom di HP */
  #dashboard-cards .col-md-4 {
    flex: 0 0 50%; /* 2 kolom di tablet */
    max-width: 50%;
  }
  @media (max-width: 768px) {
    #dashboard-cards .col-md-4 {
      flex: 0 0 100%; /* 1 kolom di HP */
      max-width: 100%;
    }
  }
  
  /* Chart: Kurangi tinggi maksimal dan pastikan responsif */
  canvas {
    max-height: 300px !important; /* Lebih kecil untuk HP */
  }
  
  /* Tabel: Tambahkan scroll horizontal untuk mencegah overflow */
  .table-box {
    overflow-x: auto; /* Scroll horizontal jika tabel lebar */
    padding: 15px;
  }
  table {
    min-width: 600px; /* Pastikan tabel tidak menyusut terlalu kecil */
    font-size: 12px; /* Font lebih kecil untuk HP */
  }
  th, td {
    padding: 6px; /* Padding lebih kecil */
    white-space: nowrap; /* Cegah teks wrap agar tabel tidak rusak */
  }
  
  /* Modal: Sesuaikan ukuran untuk layar kecil */
  .modal-content {
    width: 90%; /* Lebih lebar di HP */
    max-width: 350px; /* Maksimal tetap kecil */
    margin: 20% auto; /* Posisi lebih atas */
    padding: 15px;
  }
  
  /* Dropdown dan select: Font lebih kecil */
  select, .form-select {
    font-size: 14px;
    padding: 6px 10px;
  }
  
  /* Status dan summary: Font lebih kecil */
  #status, #summary p {
    font-size: 14px;
  }
  
  /* Tab content: Padding lebih kecil */
  .tab-content {
    padding: 10px;
  }
}

/* Khusus HP (max-width: 480px): Penyesuaian ekstra */
@media (max-width: 480px) {
  h1, h3 {
    font-size: 1.5rem; /* Judul lebih kecil */
  }
  .card-body h5 {
    font-size: 1rem;
  }
  .card-body h1 {
    font-size: 2rem;
  }
  canvas {
    max-height: 250px !important; /* Lebih kecil lagi */
  }
  table {
    font-size: 10px; /* Font minimal untuk HP kecil */
  }
}
/* Responsivitas Chart untuk HP dan Tablet */
@media (max-width: 1024px) {
  .chart-box {
    height: 400px; /* Tinggi tetap untuk tablet agar chart lebih besar */
    position: relative;
  }
  canvas {
    max-height: 400px !important; /* Tingkatkan dari 300px agar lebih besar */
  }
}

@media (max-width: 768px) {
  .chart-box {
    height: 350px; /* Tinggi untuk HP besar */
  }
  canvas {
    max-height: 350px !important; /* Tingkatkan dari 300px */
  }
}

@media (max-width: 480px) {
  .chart-box {
    height: 300px; /* Tinggi untuk HP kecil, tapi lebih besar dari sebelumnya */
  }
  canvas {
    max-height: 300px !important; /* Tingkatkan dari 250px agar tidak terlalu kecil */
  }
}
/* Perbaikan Tampilan Tab dan Card */
/* Nav Tabs: Lebih besar, dengan gradien dan efek hover */
.nav-tabs .nav-link {
  background: linear-gradient(135deg, #e8f5e8, #f1f8e9); /* Gradien hijau lembut */
  color: #2e7d32; /* Hijau gelap untuk teks */
  border: 1px solid #c8e6c9;
  border-radius: 8px 8px 0 0; /* Rounded top */
  padding: 12px 20px; /* Lebih besar */
  font-weight: bold;
  font-size: 16px;
  transition: all 0.3s ease; /* Animasi smooth */
  margin-right: 5px;
}
.nav-tabs .nav-link:hover {
  background: linear-gradient(135deg, #dcedc8, #e8f5e8); /* Gradien lebih terang saat hover */
  color: #1b5e20;
  transform: translateY(-2px); /* Efek lift */
}
.nav-tabs .nav-link.active {
  background: linear-gradient(135deg, #4caf50, #66bb6a); /* Gradien hijau aktif */
  color: white;
  box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3); /* Shadow lebih dramatis */
}

/* Cards Dashboard: Lebih besar, gradien warna unik per card, shadow, dan icon */
#dashboard-cards .card {
  border: none;
  border-radius: 15px; /* Lebih rounded */
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); /* Shadow lebih besar */
  transition: all 0.3s ease; /* Animasi hover */
  height: 150px; /* Tinggi tetap lebih besar */
  display: flex;
  align-items: center;
  justify-content: center;
}
#dashboard-cards .card:hover {
  transform: scale(1.05); /* Efek zoom saat hover */
  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.25); /* Shadow lebih dramatis */
}
#dashboard-cards .card-body {
  text-align: center;
  padding: 20px; /* Padding lebih besar */
}
#dashboard-cards .card-body h5 {
  font-size: 1.1rem;
  margin-bottom: 10px;
}
#dashboard-cards .card-body h1 {
  font-size: 2.5rem;
  font-weight: bold;
}

/* Warna gradien unik per card (sesuai tema jagung: hijau-kuning) */
#dashboard-cards .card.bg-primary { background: linear-gradient(135deg, #4caf50, #81c784); } /* Hijau untuk Segmen */
#dashboard-cards .card.bg-success { background: linear-gradient(135deg, #66bb6a, #a5d6a7); } /* Hijau muda untuk Subsegmen */
#dashboard-cards .card.bg-warning { background: linear-gradient(135deg, #ffc107, #ffeb3b); color: #333; } /* Kuning untuk Panen */
#dashboard-cards .card.bg-danger { background: linear-gradient(135deg, #f44336, #ef5350); } /* Merah untuk Bera */
#dashboard-cards .card.bg-info { background: linear-gradient(135deg, #03a9f4, #4fc3f7); } /* Biru untuk Bukan Lahan */
#dashboard-cards .card.bg-secondary { background: linear-gradient(135deg, #9e9e9e, #bdbdbd); } /* Abu untuk Bukan Jagung */

/* Tambahkan icon di card (opsional, gunakan Bootstrap Icons atau Font Awesome) */
#dashboard-cards .card-body::before {
  content: ""; /* Placeholder untuk icon, ganti dengan icon jika ada library */
  display: block;
  width: 40px;
  height: 40px;
  margin: 0 auto 10px;
  background: rgba(255, 255, 255, 0.3); /* Background transparan untuk icon */
  border-radius: 50%;
  /* Contoh: Jika pakai Font Awesome, ganti dengan <i class="fas fa-chart-line"></i> di HTML */
}

/* Responsivitas: Kurangi ukuran di HP untuk mencegah overflow */
@media (max-width: 768px) {
  .nav-tabs .nav-link {
    padding: 10px 15px;
    font-size: 14px;
  }
  #dashboard-cards .card {
    height: 120px; /* Lebih kecil di HP */
  }
  #dashboard-cards .card-body h1 {
    font-size: 2rem;
  }
}
@media (max-width: 480px) {
  #dashboard-cards .card {
    height: 100px; /* Lebih kecil lagi di HP kecil */
  }
  #dashboard-cards .card-body h1 {
    font-size: 1.8rem;
  }
}		

.panen-kuning {
  color: yellow; /* Checklist kuning */
}
</style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">POPCORN</h1>
        
        <!-- Nav Tabs -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">Dashboard</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analisis-tab" data-bs-toggle="tab" data-bs-target="#analisis" type="button" role="tab">Analisis Data</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="data-tab" data-bs-toggle="tab" data-bs-target="#data" type="button" role="tab">Data</button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="myTabContent">
            <!-- Tab Dashboard -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <h3>Informasi KSA Jagung Jawa Tengah</h3>
				<div class="mb-3">
  <label><b>Pilih Tahun Data:</b></label><br>
  <div class="btn-group" role="group" id="tahun-buttons">
    <!-- Tombol akan diisi oleh JS -->
  </div>
</div>
<div class="mb-3">
  <label><b>Pilih Bulan:</b></label><br>
  <div class="btn-group" role="group" id="bulan-buttons">
    <!-- Tombol akan diisi oleh JS -->
  </div>
</div>
                <div id="dashboard-cards" class="row">
                    <!-- Cards akan diisi oleh JS -->
                </div>
            </div>
            
            <!-- Tab Analisis Data -->
            <div class="tab-pane fade" id="analisis" role="tabpanel">
                <h3>Analisis Data</h3>
                <div class="header">
    <label for="sheetSelect"><b>Pilih Tahun / Sheet:</b></label>
  <select id="sheetSelect"></select>
  
  <!-- Tambahkan ini: Dropdown filter kabupaten -->
  <label for="kabupatenSelect"><b>Filter Kabupaten:</b></label>
  <select id="kabupatenSelect">
    <option value="">Semua Kabupaten</option>
    <!-- Opsi akan diisi oleh JS -->
  </select>
</div>

  <div id="status" class="status">⏳ Memuat data…</div>

  <div class="chart-box">
    <canvas id="chart"></canvas>
  </div>
<!-- Tambahkan di bawah <div class="chart-box"> -->
<div class="table-box">
  <h2>Identifikasi Panen Pada Sub Segmen KSA Jagung</h2>
  <div id="summary">
    <p>Kabupaten: <span id="kabupatenSummary"></span></p>
    <p>Jumlah Segmen: <span id="jumlahSegmen"></span></p>
    <p>Jumlah SubSegmen: <span id="jumlahSubSegmen"></span></p>
    <p>Jumlah panen: <span id="jumlahPanenTotal"></span></p>
  </div>
  <table id="panenTable">
    <thead>
      <tr>
        <th>Kabupaten</th>
        <th>ID-Subsegmen</th>
        <th>Jan</th>
        <th>Feb</th>
        <th>Mar</th>
        <th>Apr</th>
        <th>Mei</th>
        <th>Jun</th>
        <th>Jul</th>
        <th>Agu</th>
        <th>Sep</th>
        <th>Okt</th>
        <th>Nov</th>
        <th>Des</th>
		<th>Jumlah Panen</th>
      </tr>
    </thead>
    <tbody id="panenTableBody">
      <!-- Baris akan diisi oleh JS -->
    </tbody>
  </table>
</div>
</div>
<div id="panenModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Detail Panen</h3>
    <p id="modalText"></p>
  </div>
</div>
            
            <!-- Tab Data -->
            <div class="tab-pane fade" id="data" role="tabpanel">
                <h3>Data dari Spreadsheet</h3>
                <div class="mb-3">
                    <label for="sheet-select" class="form-label">Pilih Sheet:</label>
                    <select id="sheet-select" class="form-select">
                        <!-- Dropdown akan diisi oleh JS -->
                    </select>
                </div>
				<div class="mb-3">
    <label for="kabupaten-filter" class="form-label">Filter Kabupaten:</label>
    <select id="kabupaten-filter" class="form-select">
        <option value="">Semua Kabupaten</option>
        <!-- Dropdown akan diisi oleh JS -->
    </select>
</div>
                <div id="data-table" class="table-responsive">
                    <!-- Tabel akan diisi oleh JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Ganti dengan URL Web App Anda dari Apps Script
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyVzgu7BbbbcwJdTrTAa1QHfmAd3ZFGPnQwxzgK5wUPZd2BfdCIFhTQeRi7q2_icnmN9w/exec'; // Ganti dengan URL asli
        
		// Variabel global untuk menyimpan data asli
		let currentData = [];
		
        // Fungsi untuk mengambil daftar sheet
        async function fetchSheetsList() {
            const url = `${APPS_SCRIPT_URL}?action=getSheets`;
            try {
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error('Error fetching sheets list:', error);
                return [];
            }
        }
        
        // Fungsi untuk mengambil data dari sheet tertentu
        async function fetchSheetData(sheetName) {
            const url = `${APPS_SCRIPT_URL}?action=getData&sheet=${sheetName}`;
            try {
                const response = await fetch(url);
                return await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                return [];
            }
        }
        
        // Fungsi untuk membuat tabel dari array objek
        function createTable(data) {
            if (data.length === 0) return '<p>Tidak ada data.</p>';
            const keys = Object.keys(data[0]);
            let table = '<table class="table table-striped"><thead><tr>';
            keys.forEach(key => table += `<th>${key}</th>`);
            table += '</tr></thead><tbody>';
            data.forEach(row => {
                table += '<tr>';
                keys.forEach(key => table += `<td>${row[key]}</td>`);
                table += '</tr>';
            });
            table += '</tbody></table>';
            return table;
        }
        
        // Load Dashboard
        async function loadDashboard() {
            const data = await fetch(`${APPS_SCRIPT_URL}?action=dashboard`).then(r => r.json());
            if (data.length > 0) {
                // Asumsi kolom: 'Amatan', 'Hasil', dll. Sesuaikan jika berbeda
                const totalAmatan = data.reduce((sum, row) => sum + (parseFloat(row.Amatan) || 0), 0);
                const avgHasil = data.reduce((sum, row) => sum + (parseFloat(row.Hasil) || 0), 0) / data.length;
                document.getElementById('dashboard-cards').innerHTML = `
                    <div class="col-md-4"><div class="card"><div class="card-body"><h5>Total Amatan</h5><p>${totalAmatan}</p></div></div></div>
                    <div class="col-md-4"><div class="card"><div class="card-body"><h5>Rata-rata Hasil</h5><p>${avgHasil.toFixed(2)}</p></div></div></div>
                    <div class="col-md-4"><div class="card"><div class="card-body"><h5>Jumlah Data</h5><p>${data.length}</p></div></div></div>
                `;
            }
        }
        
        // Load Analisis Data
async function loadAnalisis() {
    try {
        const data = await fetch(`${APPS_SCRIPT_URL}?action=analysis`).then(r => r.json());
        console.log('Analysis data loaded:', data.length, 'rows');
        console.log('Sample data:', data.slice(0, 5)); // Debug: Lihat sample data
        
        if (data.length === 0) {
            console.warn('No data for analysis');
            document.getElementById('lainnya-content').innerHTML = '<p>Tidak ada data analisis.</p>';
            return;
        }
        
        // Fallback key: Jika "Bulan" tidak ada, gunakan key pertama; jika "Nilai Amatan" tidak ada, gunakan key kedua
        const keys = Object.keys(data[0]);
        const bulanKey = keys.find(key => key.toLowerCase().includes('bulan') || key.toLowerCase().includes('month')) || keys[0]; // Fallback ke key pertama
        const nilaiKey = keys.find(key => key.toLowerCase().includes('nilai amatan') || key.toLowerCase().includes('amatan')) || keys[1]; // Fallback ke key kedua
        console.log('Using bulanKey:', bulanKey, 'nilaiKey:', nilaiKey);
        
        // Kelompokkan data berdasarkan bulan
        const groupedByBulan = {};
        data.forEach(row => {
            const bulan = row[bulanKey];
            const nilai = row[nilaiKey];
            if (bulan && nilai !== undefined) { // Skip jika bulan atau nilai kosong
                if (!groupedByBulan[bulan]) groupedByBulan[bulan] = {};
                groupedByBulan[bulan][nilai] = (groupedByBulan[bulan][nilai] || 0) + 1;
            }
        });
        console.log('Grouped data:', groupedByBulan);
        
        // Dapatkan semua bulan unik dan nilai amatan unik
        const bulanLabels = Object.keys(groupedByBulan).sort(); // Sort bulan
        const nilaiUnik = [...new Set(data.map(row => row[nilaiKey]).filter(val => val !== undefined))].sort((a, b) => a - b); // Sort nilai, filter undefined
        console.log('Bulan labels:', bulanLabels, 'Nilai unik:', nilaiUnik);
        
        if (bulanLabels.length === 0 || nilaiUnik.length === 0) {
            console.warn('No valid data for chart');
            document.getElementById('lainnya-content').innerHTML = '<p>Data tidak valid untuk grafik.</p>';
            return;
        }
        
        // Buat datasets untuk stacked chart
        const colors = ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 205, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)']; // Warna fixed
        const datasets = nilaiUnik.map((nilai, index) => ({
            label: `Nilai Amatan ${nilai}`,
            data: bulanLabels.map(bulan => groupedByBulan[bulan][nilai] || 0),
            backgroundColor: colors[index % colors.length] // Warna berulang jika lebih dari 5
        }));
        
        // Update stacked chart
        const ctx = document.getElementById('stackedChart');
        if (ctx) {
            new Chart(ctx, {
                type: 'bar',
                data: { labels: bulanLabels, datasets },
                options: {
                    scales: { x: { stacked: true }, y: { stacked: true } },
                    plugins: { title: { display: true, text: 'Stacked Chart Amatan KSA Berdasarkan Bulan' } }
                }
            });
            console.log('Stacked chart created');
        } else {
            console.error('Canvas stackedChart not found');
        }
        
        // Pola Petanaman tetap (asumsi line chart)
        const polaKey = keys.find(key => key.toLowerCase().includes('pola') || key.toLowerCase().includes('petanaman')) || keys[2] || bulanKey; // Fallback
        const polaLabels = data.map(row => row[bulanKey]);
        const polaData = data.map(row => row[polaKey] || 0);
        const polaCtx = document.getElementById('polaChart');
        if (polaCtx) {
            new Chart(polaCtx, { 
                type: 'line', 
                data: { labels: polaLabels, datasets: [{ label: 'Pola Petanaman', data: polaData, borderColor: 'rgba(75, 192, 192, 1)' }] } 
            });
        }
        
        // Lainnya: Tampilkan ringkasan
        document.getElementById('lainnya-content').innerHTML = `<p>Total data analisis: ${data.length}</p><p>Bulan unik: ${bulanLabels.join(', ')}</p>`;
    } catch (error) {
        console.error('Error in loadAnalisis:', error);
        document.getElementById('lainnya-content').innerHTML = '<p>Error loading analisis data. Check console.</p>';
    }
}
		
		// Fungsi untuk populate dropdown filter Kabupaten
// Fungsi untuk populate dropdown filter Kabupaten
function populateKabupatenFilter(data) {
    const select = document.getElementById('kabupaten-filter');
    select.innerHTML = '<option value="">Semua Kabupaten</option>';
    if (data.length === 0) return;
    
    // Debug: Lihat key header dan nilai kolom A
    console.log('Keys in data:', Object.keys(data[0]));
    console.log('Sample data rows:', data.slice(0, 3)); // Lihat struktur data
    
    // Asumsi key untuk kolom A adalah "Kabupaten"; jika tidak, gunakan key pertama sebagai fallback
    const kabupatenKey = Object.keys(data[0]).find(key => key.toLowerCase().includes('kabupaten') || key.toLowerCase().includes('daerah') || key.toLowerCase().includes('kode')) || Object.keys(data[0])[0]; // Fallback ke key pertama
    console.log('Using key for Kabupaten:', kabupatenKey);
    
    try {
        const kabupatenSet = new Set(data.map(row => (row[kabupatenKey] || '').toString().trim()).filter(val => val)); // Trim, filter empty, toString untuk safety
        kabupatenSet.forEach(kab => {
            const option = document.createElement('option');
            option.value = kab;
            option.textContent = kab;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error populating filter:', error);
    }
}

// Fungsi untuk menampilkan data yang difilter
function displayFilteredData(data) {
    document.getElementById('data-table').innerHTML = createTable(data);
}

// Fungsi untuk filter data berdasarkan Kabupaten
function filterData() {
    const selectedKabupaten = document.getElementById('kabupaten-filter').value.trim();
    console.log('Selected Kabupaten:', selectedKabupaten);
    
    if (!currentData.length) {
        console.warn('No data to filter');
        return;
    }
    
    // Gunakan key yang sama seperti di populateKabupatenFilter
    const kabupatenKey = Object.keys(currentData[0]).find(key => key.toLowerCase().includes('kabupaten') || key.toLowerCase().includes('daerah') || key.toLowerCase().includes('kode')) || Object.keys(currentData[0])[0];
    console.log('Filtering with key:', kabupatenKey);
    
    try {
        const filteredData = selectedKabupaten ? currentData.filter(row => (row[kabupatenKey] || '').toString().trim().toLowerCase() === selectedKabupaten.toLowerCase()) : currentData;
        console.log('Filtered data length:', filteredData.length);
        displayFilteredData(filteredData);
    } catch (error) {
        console.error('Error filtering data:', error);
        displayFilteredData(currentData); // Fallback: tampilkan semua data jika error
    }
}
        
       // Load Data Tab
async function loadData(sheetName) {
    try {
        currentData = await fetchSheetData(sheetName);
        console.log('Loaded data for sheet:', sheetName, 'Length:', currentData.length);
        populateKabupatenFilter(currentData);
        displayFilteredData(currentData);
    } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('data-table').innerHTML = '<p>Error loading data. Check console.</p>';
    }
}
        
        // Populate dropdown dan load data awal
        async function initDataTab() {
            const sheets = await fetchSheetsList();
            const select = document.getElementById('sheet-select');
            select.innerHTML = '';
            sheets.forEach(sheet => {
                const option = document.createElement('option');
                option.value = sheet;
                option.textContent = sheet;
                select.appendChild(option);
            });
            // Load data default (sheet pertama)
            if (sheets.length > 0) loadData(sheets[0]);
        }
        
        // Event listeners
document.getElementById('sheet-select').addEventListener('change', (e) => loadData(e.target.value));
document.getElementById('kabupaten-filter').addEventListener('change', filterData); // Tambahkan ini
        
        // Load awal
        loadDashboard();
        loadAnalisis();
        initDataTab();
		
		
	const API_URL =
  "https://script.google.com/macros/s/AKfycbx6y99wUJIR2Ex9yyZK2yaAZMvxQuqHS3ZY9d5C0D-yjaWak8jL_RM4h1FzDS20fs2j/exec";

let apiData = {};
let chartInstance = null;
let rawData = {}; // Tambahkan untuk menyimpan data mentah per sheet
// Warna konsisten untuk fase
const COLORS = {
  "Tidak diamati": "#BDBDBD",
  "Vegetatif Awal": "#8BC34A",
  "Vegetatif Akhir": "#4CAF50",
  "Reproduktif Awal": "#FFC107",
  "Reproduktif Akhir": "#FF9800",
  "Panen Hijauan": "#795548",
  "Panen Muda": "#FF5722",
  "Panen Pipilan": "#E91E63",
  "Persiapan Lahan": "#03A9F4",
  "Lahan Pertanian Bukan Jagung": "#9E9E9E",
  "Bukan Lahan Pertanian": "#607D8B",
  "Puso": "#000000",
  "Bera": "#9C27B0"
};

const PHASE_DESCRIPTIONS = {
  5: "Panen Hijauan",
  6: "Panen Muda",
  7: "Panen Pipilan"
};

fetch(API_URL)
  .then(res => res.json())
  .then(data => {
    apiData = data;
    const sheets = Object.keys(data);

    const select = document.getElementById("sheetSelect");
    sheets.forEach(s => {
      const opt = document.createElement("option");
      opt.value = s;
      opt.textContent = s;
      select.appendChild(opt);
    });

    // Kumpulkan semua kabupaten unik dari semua sheet
    const allKabupaten = new Set();
    sheets.forEach(s => {
      if (apiData[s].kabupaten) {
        apiData[s].kabupaten.forEach(kab => allKabupaten.add(kab));
      }
    });
// Load rawData untuk semua sheets agar bisa hitung metrik total
    const loadAllRawDataPromises = sheets.map(sheet => 
      fetch(`${API_URL}?action=getRawData&sheet=${encodeURIComponent(sheet)}`)
        .then(res => res.json())
        .then(data => { rawData[sheet] = data; })
        .catch(err => console.error(`Gagal load rawData untuk ${sheet}:`, err))
    );
    
    Promise.all(loadAllRawDataPromises).then(() => {
      // Gabungkan semua rawData dari semua sheets
      const allData = [];
      sheets.forEach(s => {
        if (rawData[s]) allData.push(...rawData[s]);
      });
      
	  // Set default tahun ke sheet pertama (2025)
    const defaultSheet = sheets[0];
    const defaultMetrics = calculateMetrics(rawData[defaultSheet] || []);
    updateDashboardCards(defaultMetrics);
    
    // Buat tombol untuk setiap sheet (tahun)
    const buttonContainer = document.getElementById('tahun-buttons');
    sheets.forEach((sheet, index) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-outline-primary';
      if (index === 0) btn.classList.add('active'); // Default aktif
      btn.textContent = sheet;
      btn.dataset.sheet = sheet;
      buttonContainer.appendChild(btn);
    });
    
    // Event listener untuk tombol tahun
    buttonContainer.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        // Hapus active dari semua tombol
        buttonContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        // Tambah active ke tombol yang diklik
        e.target.classList.add('active');
        
        const selectedSheet = e.target.dataset.sheet;
        const metrics = calculateMetrics(rawData[selectedSheet] || []);
        updateDashboardCards(metrics);
      }
    });

	  
      // Hitung metrik
      const metrics = calculateMetrics(allData);
      
      // Update cards dashboard
      updateDashboardCards(metrics);
    }).catch(err => {
      console.error("Error loading all rawData:", err);
    });
    // Isi dropdown kabupaten
    const kabupatenSelect = document.getElementById("kabupatenSelect");
    Array.from(allKabupaten).sort().forEach(kab => {
      const opt = document.createElement("option");
      opt.value = kab;
      opt.textContent = kab;
      kabupatenSelect.appendChild(opt);
    });

    document.getElementById("status").textContent = "✅ Data berhasil dimuat";

    // Render pertama (sheet pertama, tanpa filter)
    renderChart(sheets[0]);
    loadRawData(sheets[0]); // Load raw data untuk tabel

    // Event dropdown sheet
    select.addEventListener("change", e => {
      const selectedKabupaten = document.getElementById("kabupatenSelect").value;
      renderChart(e.target.value, selectedKabupaten);
      loadRawData(e.target.value); // Load raw data saat ganti sheet
    });

    // Event dropdown kabupaten
    kabupatenSelect.addEventListener("change", e => {
      const selectedSheet = document.getElementById("sheetSelect").value;
      renderChart(selectedSheet, e.target.value);
      renderTable(selectedSheet, e.target.value); // Tambahkan ini untuk update tabel berdasarkan filter kabupaten
    });
  })
  .catch(err => {
    console.error(err);
    document.getElementById("status").textContent =
      "❌ Gagal memuat data API";
  });

// Fungsi untuk load raw data
function loadRawData(sheetName) {
  fetch(`${API_URL}?action=getRawData&sheet=${encodeURIComponent(sheetName)}`)
    .then(res => res.json())
    .then(data => {
      rawData[sheetName] = data;
      const selectedKabupaten = document.getElementById("kabupatenSelect").value;
      renderTable(sheetName, selectedKabupaten);
    })
    .catch(err => {
      console.error("Gagal memuat raw data:", err);
    });
}


function renderTable(sheetName, filterKabupaten = "") {
  const data = rawData[sheetName];
  if (!data) return;

  const tbody = document.getElementById("panenTableBody");
  tbody.innerHTML = ""; // Kosongkan tabel

  // Kelompokkan data berdasarkan Kabupaten dan ID-Subsegmen
  const grouped = {};
  data.forEach(row => {
    const kab = row.A || row.Kabupaten;
    const subseg = row.B || row['ID-Subsegmen'];
    const key = `${kab}-${subseg}`;
    if (!grouped[key]) {
      grouped[key] = { kab: kab, subseg: subseg, bulan: Array(12).fill(null).map(() => []) };
    }
    // Kolom D sampai O (index 3 sampai 14) untuk Jan-Des
    for (let i = 3; i <= 14; i++) {
      const colName = String.fromCharCode(65 + i);
      const nilai = row[colName] || row[Object.keys(row)[i]];
      const bulanIndex = i - 3;
      if (nilai) {
        grouped[key].bulan[bulanIndex].push(parseInt(nilai));
      }
    }
  });

  // Filter berdasarkan kabupaten jika ada
  let filteredGrouped = Object.values(grouped);
  if (filterKabupaten) {
    filteredGrouped = filteredGrouped.filter(item => item.kab == filterKabupaten);
  }

  let totalJumlahPanen = 0;

  // Buat baris tabel
  filteredGrouped.forEach(item => {
    const tr = document.createElement("tr");
    
    // Buat td untuk kabupaten
    const tdKab = document.createElement("td");
    tdKab.textContent = item.kab;
    tr.appendChild(tdKab);
    
    // Buat td untuk subsegmen
    const tdSubseg = document.createElement("td");
    tdSubseg.textContent = item.subseg;
    tr.appendChild(tdSubseg);
    
    // Buat td untuk bulan
    item.bulan.forEach((vals, idx) => {
      const td = document.createElement("td");
      let isPanen = false;
      let isKuning = false;
      let panenCode = null;
      
      // Cek nilai asli untuk panen (5,6,7)
      if (vals.some(v => [5,6,7].includes(v))) {
        isPanen = true;
        panenCode = vals.filter(v => [5,6,7].includes(v)).join(",");
      }
      
      // Cek kondisi baru: bulan sebelumnya
      if (idx > 0) { // Hanya jika bukan Januari
        const prevVals = item.bulan[idx - 1];
        const prevNilai = prevVals.length > 0 ? prevVals[prevVals.length - 1] : null; // Ambil nilai terakhir bulan sebelumnya
        const currNilai = vals.length > 0 ? vals[vals.length - 1] : null; // Ambil nilai terakhir bulan ini
        
        if (prevNilai === 3 && [1,2].includes(currNilai)) {
          isPanen = true;
          isKuning = true;
          panenCode = "6"; // Override untuk popup
        } else if (prevNilai === 4 && [1,2,3].includes(currNilai)) {
          isPanen = true;
          isKuning = true;
          panenCode = "7"; // Override untuk popup
        }
      }
      
      if (isPanen) {
        td.className = isKuning ? "panen panen-kuning" : "panen";
        td.setAttribute("data-nilai", panenCode);
        td.textContent = "✓";
      } else {
        td.textContent = "0";
      }
      tr.appendChild(td);
    });
    
    // Hitung jumlah panen: jumlah kelompok consecutive bulan dengan panen
    const panenBulan = item.bulan.map((vals, idx) => vals.some(v => [5,6,7].includes(v)) || (idx > 0 && ((item.bulan[idx-1].length > 0 && item.bulan[idx-1][item.bulan[idx-1].length-1] === 3 && [1,2].includes(vals[vals.length-1])) || (item.bulan[idx-1].length > 0 && item.bulan[idx-1][item.bulan[idx-1].length-1] === 4 && [1,2,3].includes(vals[vals.length-1])))) ? idx : -1).filter(idx => idx !== -1);
    let jumlahPanen = 0;
    if (panenBulan.length > 0) {
      jumlahPanen = 1; // Setidaknya 1
      for (let i = 1; i < panenBulan.length; i++) {
        if (panenBulan[i] !== panenBulan[i-1] + 1) {
          jumlahPanen++;
        }
      }
    }
    
    // Buat td untuk jumlah panen
    const tdJumlah = document.createElement("td");
    tdJumlah.textContent = jumlahPanen;
    tr.appendChild(tdJumlah);
    
    tbody.appendChild(tr);

    totalJumlahPanen += jumlahPanen;
  });

  // Update summary
  document.getElementById("kabupatenSummary").textContent = filterKabupaten || "Semua Kabupaten";
  const jumlahSubSegmen = filteredGrouped.length;
  document.getElementById("jumlahSubSegmen").textContent = jumlahSubSegmen;
  document.getElementById("jumlahSegmen").textContent = Math.floor(jumlahSubSegmen / 4);
  document.getElementById("jumlahPanenTotal").textContent = totalJumlahPanen;
}
function renderChart(sheetName, filterKabupaten = "") {
  const sheet = apiData[sheetName];
  const ctx = document.getElementById("chart").getContext("2d");

  if (chartInstance) chartInstance.destroy();

  let labels = sheet.labels;
  let seriesData;

  if (filterKabupaten) {
    // Gunakan data per kabupaten
    if (sheet.data && sheet.data[filterKabupaten]) {
      seriesData = sheet.data[filterKabupaten];
    } else {
      // Jika kabupaten tidak ditemukan, tampilkan kosong
      seriesData = {};
      Object.keys(COLORS).forEach(key => seriesData[key] = Array(12).fill(0));
    }
  } else {
    // Gunakan aggregated (semua kabupaten)
    seriesData = sheet.aggregated;
  }

  const datasets = Object.keys(seriesData).map(label => ({
    label: label,
    data: seriesData[label],
    backgroundColor: COLORS[label] || "#cccccc"
  }));

  chartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: datasets
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: "right"
        },
        title: {
          display: true,
          text: "Tahun / Sheet: " + sheetName + (filterKabupaten ? " - Kabupaten: " + filterKabupaten : "")
        }
      },
      scales: {
        x: { stacked: true },
        y: {
          stacked: true,
          beginAtZero: true,
          title: { display: true, text: "Jumlah Amatan" }
        }
      }
    }
  });
}

// Tambahkan console.log tambahan di event listener untuk debug lebih lanjut
document.getElementById("panenTableBody").addEventListener("click", function(e) {
  console.log("Event triggered on tbody");
  console.log("Clicked element:", e.target);
  if (e.target.classList.contains("panen")) {
    const nilaiStr = e.target.getAttribute("data-nilai");
    console.log("Data-nilai:", nilaiStr);
    let modalText = "";
    if (nilaiStr === "6") {
      modalText = "Panen diantara 2 survei kode 6 Panen Muda";
    } else if (nilaiStr === "7") {
      modalText = "Panen diantara 2 survei kode 7 Panen Pipilan";
    } else {
      const nilais = nilaiStr.split(",").map(n => parseInt(n));
      const faseList = nilais.map(n => PHASE_DESCRIPTIONS[n] || "Tidak diketahui").join(", ");
      modalText = `Nilai Amatan: ${nilaiStr}<br>Fase Amatan: ${faseList}`;
    }
    console.log("Modal text:", modalText);
    document.getElementById("modalText").innerHTML = modalText;
    document.getElementById("panenModal").style.display = "block";
    console.log("Modal should be visible now");
  }
});
// Event untuk close modal
document.querySelector(".close").addEventListener("click", function() {
  document.getElementById("panenModal").style.display = "none";
});

// Klik di luar modal untuk close
window.addEventListener("click", function(event) {
  if (event.target == document.getElementById("panenModal")) {
    document.getElementById("panenModal").style.display = "none";
  }
});

function calculateMetrics(data) {
  const subSegmenSet = new Set();
  const panenSet = new Set();
  const beraSet = new Set();
  const bukanLahanSet = new Set();
  const bukanJagungSet = new Set();
  
  data.forEach(row => {
    const subseg = row.B || row['ID-Subsegmen'];
    if (subseg) subSegmenSet.add(subseg);
    
    // Kolom D sampai O (Jan-Des, index 3-14)
    for (let i = 3; i <= 14; i++) {
      const colName = String.fromCharCode(65 + i);
      const nilai = parseInt(row[colName] || row[Object.keys(row)[i]] || 0);
      
      if ([5, 6, 7].includes(nilai)) panenSet.add(subseg);  // Panen Hijauan, Muda, Pipilan
      if (nilai === 15) beraSet.add(subseg);  // Bera
      if (nilai === 10) bukanLahanSet.add(subseg);  // Bukan Lahan Pertanian
      if (nilai === 9) bukanJagungSet.add(subseg);  // Lahan Pertanian Bukan Jagung
    }
  });
  
  return {
    jumlahSegmen: Math.floor(subSegmenSet.size / 4),  // Asumsi 1 segmen = 4 subsegmen
    jumlahSubsegmen: subSegmenSet.size,
    jumlahSubsegmenPanen: panenSet.size,
    jumlahSubsegmenBera: beraSet.size,
    jumlahSubsegmenBukanLahan: bukanLahanSet.size,
    jumlahSubsegmenBukanJagung: bukanJagungSet.size
  };
}

const bulanNames = ["Semua Bulan", "Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
    const bulanContainer = document.getElementById('bulan-buttons');
    bulanNames.forEach((bulan, index) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'btn btn-outline-secondary';
      if (index === 0) btn.classList.add('active'); // Default "Semua Bulan" aktif
      btn.textContent = bulan;
      btn.dataset.bulanIndex = index === 0 ? null : index - 1; // 0=Semua, 1=Jan(0), 2=Feb(1), ..., 13=Des(11)
      bulanContainer.appendChild(btn);
    });
    
    // Variabel untuk menyimpan bulan yang dipilih (default null = semua bulan)
    let selectedBulanIndex = null;
    
    // Event listener untuk tombol bulan
    bulanContainer.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        // Hapus active dari semua tombol bulan
        bulanContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        // Tambah active ke tombol yang diklik
        e.target.classList.add('active');
        
        selectedBulanIndex = e.target.dataset.bulanIndex ? parseInt(e.target.dataset.bulanIndex) : null;
        
        // Update metrik berdasarkan tahun dan bulan yang dipilih
        const selectedSheet = document.querySelector('#tahun-buttons .active').dataset.sheet;
        const metrics = calculateMetrics(rawData[selectedSheet] || [], selectedBulanIndex);
        updateDashboardCards(metrics);
      }
    });
    
    // Modifikasi event listener tombol tahun untuk juga memperhitungkan bulan yang dipilih
    buttonContainer.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') {
        // Hapus active dari semua tombol tahun
        buttonContainer.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        // Tambah active ke tombol yang diklik
        e.target.classList.add('active');
        
        const selectedSheet = e.target.dataset.sheet;
        const metrics = calculateMetrics(rawData[selectedSheet] || [], selectedBulanIndex);
        updateDashboardCards(metrics);
      }
    });

// Modifikasi fungsi calculateMetrics(data, bulanIndex = null) untuk menerima parameter bulanIndex
function calculateMetrics(data, bulanIndex = null) {
  const subSegmenSet = new Set();
  const panenSet = new Set();
  const beraSet = new Set();
  const bukanLahanSet = new Set();
  const bukanJagungSet = new Set();
  
  data.forEach(row => {
    const subseg = row.B || row['ID-Subsegmen'];
    if (subseg) subSegmenSet.add(subseg);
    
    // Jika bulanIndex null, hitung semua bulan (kolom 3-14); jika ada, hanya kolom tertentu
    const bulanIndices = bulanIndex !== null ? [bulanIndex + 3] : Array.from({length: 12}, (_, i) => i + 3); // 3=Jan, 4=Feb, ..., 14=Des
    
    bulanIndices.forEach(i => {
      const colName = String.fromCharCode(65 + i);
      const nilai = parseInt(row[colName] || row[Object.keys(row)[i]] || 0);
      
      if ([5, 6, 7].includes(nilai)) panenSet.add(subseg);  // Panen Hijauan, Muda, Pipilan
      if (nilai === 15) beraSet.add(subseg);  // Bera
      if (nilai === 10) bukanLahanSet.add(subseg);  // Bukan Lahan Pertanian
      if (nilai === 9) bukanJagungSet.add(subseg);  // Lahan Pertanian Bukan Jagung
    });
  });
  
  return {
    jumlahSegmen: Math.floor(subSegmenSet.size / 4),  // Asumsi 1 segmen = 4 subsegmen
    jumlahSubsegmen: subSegmenSet.size,
    jumlahSubsegmenPanen: panenSet.size,
    jumlahSubsegmenBera: beraSet.size,
    jumlahSubsegmenBukanLahan: bukanLahanSet.size,
    jumlahSubsegmenBukanJagung: bukanJagungSet.size
  };
}


function updateDashboardCards(metrics) {
  const cardsHtml = `
    <div class="col-md-4 mb-3">
      <div class="card bg-primary text-white h-100">
        <div class="card-body d-flex flex-column justify-content-center">
          <h5>Jumlah Segmen</h5>
          <h1 class="text-center font-weight-bold">${metrics.jumlahSegmen}</h1>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card bg-success text-white h-100">
        <div class="card-body d-flex flex-column justify-content-center">
          <h5>Jumlah Subsegmen</h5>
          <h1 class="text-center font-weight-bold">${metrics.jumlahSubsegmen}</h1>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card bg-warning text-dark h-100">
        <div class="card-body d-flex flex-column justify-content-center">
          <h5>Jumlah SubSegmen yang Panen</h5>
          <h1 class="text-center font-weight-bold">${metrics.jumlahSubsegmenPanen}</h1>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card bg-danger text-white h-100">
        <div class="card-body d-flex flex-column justify-content-center">
          <h5>Jumlah Subsegmen yang Bera</h5>
          <h1 class="text-center font-weight-bold">${metrics.jumlahSubsegmenBera}</h1>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card bg-info text-white h-100">
        <div class="card-body d-flex flex-column justify-content-center">
          <h5>Jumlah Subsegmen yang Bukan Lahan Pertanian</h5>
          <h1 class="text-center font-weight-bold">${metrics.jumlahSubsegmenBukanLahan}</h1>
        </div>
      </div>
    </div>
    <div class="col-md-4 mb-3">
      <div class="card bg-secondary text-white h-100">
        <div class="card-body d-flex flex-column justify-content-center">
          <h5>Jumlah Subsegmen yang Lahan Pertanian Bukan Jagung</h5>
          <h1 class="text-center font-weight-bold">${metrics.jumlahSubsegmenBukanJagung}</h1>
        </div>
      </div>
    </div>
  `;
  document.getElementById('dashboard-cards').innerHTML = cardsHtml;
}

    </script>
</body>
</html>
